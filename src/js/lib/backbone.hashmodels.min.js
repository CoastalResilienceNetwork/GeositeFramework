/*! backbone.hashmodels 2013-03-11 */
Backbone.HashModels=function(Backbone,_,$){"use strict";var encodeUtf8=function(string){string=string.replace(/\r\n/g,"\n");var n,utftext="";for(n=0;string.length>n;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(192|c>>6),utftext+=String.fromCharCode(128|63&c)):(utftext+=String.fromCharCode(224|c>>12),utftext+=String.fromCharCode(128|63&c>>6),utftext+=String.fromCharCode(128|63&c))}return utftext},decodeUtf8=function(utftext){for(var string="",i=0,c=0,c2=0,c3=0;utftext.length>i;)c=utftext.charCodeAt(i),128>c?(string+=String.fromCharCode(c),i++):c>191&&224>c?(c2=utftext.charCodeAt(i+1),string+=String.fromCharCode((31&c)<<6|63&c2),i+=2):(c2=utftext.charCodeAt(i+1),c3=utftext.charCodeAt(i+2),string+=String.fromCharCode((15&c)<<12|(63&c2)<<6|63&c3),i+=3);return string},_base64Key="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encodeBase64=function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=encodeUtf8(input);input.length>i;)chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+_base64Key.charAt(enc1)+_base64Key.charAt(enc2)+_base64Key.charAt(enc3)+_base64Key.charAt(enc4);return output},decodeBase64=function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");input.length>i;)enc1=_base64Key.indexOf(input.charAt(i++)),enc2=_base64Key.indexOf(input.charAt(i++)),enc3=_base64Key.indexOf(input.charAt(i++)),enc4=_base64Key.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!==enc3&&(output+=String.fromCharCode(chr2)),64!==enc4&&(output+=String.fromCharCode(chr3));return output=decodeUtf8(output)},compressLzw=function(s){var currChar,i,dict={},data=(s+"").split(""),out=[],phrase=data[0],code=256;for(i=1;data.length>i;i++)currChar=data[i],dict[phrase+currChar]?phrase+=currChar:(out.push(phrase.length>1?dict[phrase]:phrase.charCodeAt(0)),dict[phrase+currChar]=code,code++,phrase=currChar);for(out.push(phrase.length>1?dict[phrase]:phrase.charCodeAt(0)),i=0;out.length>i;i++)out[i]=String.fromCharCode(out[i]);return out.join("")},decompressLzw=function(s){var phrase,i,dict={},data=(s+"").split(""),currChar=data[0],oldPhrase=currChar,out=[currChar],code=256;for(i=1;data.length>i;i++){var currCode=data[i].charCodeAt(0);phrase=256>currCode?data[i]:dict[currCode]?dict[currCode]:oldPhrase+currChar,out.push(phrase),currChar=phrase.charAt(0),dict[code]=oldPhrase+currChar,code++,oldPhrase=phrase}return out.join("")},models={},watchedModelAttributes={},initialModelStates={},state={},stateString="",pendingState={},pendingStateString="",validdateEncodedCompressesStateString=function(s){if(s)return s;throw{name:"ArgumentFalsey",message:"Cannot convert falsey string to an object."}},decodeStateObject=_.compose(JSON.parse,decompressLzw,decodeBase64,validdateEncodedCompressesStateString),encodeStateObject=_.compose(encodeBase64,compressLzw,JSON.stringify),defaultHashUpdateFunction=function(hash){$.history.load(hash)},updateHash=defaultHashUpdateFunction,setupDefaultHashMonitorCallback=function(cb){$.history.init(cb)},handleModelChanged=function(model){var newValues,modelId,oldState=_.extend({},state),oldStateString=stateString;if(_.each(models,function(value,key){value===model&&(modelId=key)}),void 0===modelId)throw"Could not determine ID for model "+JSON.stringify(model.attributes);try{newValues=model.getState?model.getState():watchedModelAttributes[modelId]?_.pick(model.attributes,watchedModelAttributes[modelId]):model.attributes,options.updateOnChange?(state[modelId]=newValues,stateString=encodeStateObject(state),updateHash(stateString),HashModels.trigger("change",stateString)):(pendingState[modelId]=newValues,pendingStateString=encodeStateObject(pendingState))}catch(err){state=oldState,stateString=oldStateString}},handleHashChanged=function(hash){var newState={},newStateString="";hash!==stateString&&(hash?(newStateString=hash,newState=decodeStateObject(hash),_.each(newState,function(value,key){models[key]&&value?models[key].setState?models[key].setState(value):models[key].set(value):models[key]&&(models[key].setState?models[key].setState(initialModelStates[key]):models[key].set(initialModelStates[key]))})):_.each(models,function(model,key){model.setState?model.setState(initialModelStates[key]):model.set(initialModelStates[key])}),state=newState,stateString=newStateString,HashModels.trigger("change",stateString))},options={updateOnChange:!0},HashModels={init:function(opts){return options=_.extend(options,opts),models={},watchedModelAttributes={},initialModelStates={},state={},stateString="",pendingState={},pendingStateString="",updateHash=options.hashUpdateCallback||defaultHashUpdateFunction,options.setupHashMonitorCallback?options.setupHashMonitorCallback(handleHashChanged):setupDefaultHashMonitorCallback(handleHashChanged),this},addModel:function(model,opts){var initialState,modelOptions,eventsToWatch="change";modelOptions=_.isString(opts)?{id:opts}:_.extend({},opts);var modelId=modelOptions.id||model.id;if(!modelId)throw Error("Options does not contain a truthy 'id' property and the model does not have a truthy 'id' attribute");if(void 0!==models[modelId])throw Error("A model has already been added with id '"+modelId+'"');return models[modelId]=model,initialState=model.getState?model.getState():modelOptions.attributes&&modelOptions.attributes.length?_.pick(model.attributes,modelOptions.attributes):_.extend({},model.attributes),initialModelStates[modelId]=initialState,modelOptions.attributes&&modelOptions.attributes.length?(watchedModelAttributes[modelId]=_.extend({},modelOptions.attributes),eventsToWatch=_.map(modelOptions.attributes,function(name){return"change:"+name}).join(" ")):watchedModelAttributes[modelId]=null,state[modelId]&&(model.setState?model.setState(state[modelId]):model.set(state[modelId])),model.on(eventsToWatch,handleModelChanged,model),this.trigger("add",model,modelId),modelId},update:function(){state=_.extend({},pendingState),stateString=pendingStateString,updateHash(stateString),HashModels.trigger("change",stateString)},decodeStateObject:decodeStateObject,encodeStateObject:encodeStateObject};return _.extend(HashModels,Backbone.Events),HashModels}(Backbone,_,jQuery);